<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>R.C Technical Institute ‚Äî CO11 Attendance (Corrected Exports)</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#0d1b2a; --card:#10263a; --accent:#00ff99; --text:#e6eef6; --muted:#93a7bf; --border:rgba(0,255,153,0.08);
    font-family:Inter, Arial, sans-serif;
  }
  [data-theme="light"]{
    --bg:#f5f7fb; --card:#ffffff; --text:#111; --muted:#5b6b7a; --border:rgba(10,150,90,0.06);
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  .page{max-width:1200px;margin:20px auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:14px}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#00cc88,#0066ff);display:flex;align-items:center;justify-content:center;font-weight:800;color:#022}
  h1{margin:0;font-size:20px;color:var(--accent)}
  .muted{color:var(--muted);font-size:13px}
  .auth{display:flex;gap:8px;align-items:center;margin-left:auto}
  .input{padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);outline:none}
  button{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer;font-weight:700; transition: transform 0.15s ease-out;}
  button:hover{transform: scale(1.05);}
  .btn-primary{background:linear-gradient(135deg,#00ff99,#3a86ff);border:none;color:#042}
  .btn-ghost{border-style:dashed}
  .layout{display:grid;grid-template-columns:1fr 420px;gap:16px}
  .card{background:var(--card);padding:12px;border-radius:12px;border:1px solid var(--border)}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .title{font-weight:800;color:var(--accent)}
  .master-scroll{max-height:540px;overflow:auto;padding:6px;border-radius:8px;border:1px solid var(--border)}
  .row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px; transition: background-color 0.3s;}
  .row:hover{background:rgba(255,255,255,0.02)}
  .row.highlight { animation: highlight-fade 1.5s ease-out; }
  .row.current { background-color: rgba(0, 255, 153, 0.1); }
  @keyframes highlight-fade { 0% { background-color: rgba(0, 255, 153, 0.3); } 100% { background-color: transparent; } }
  .avatar{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#00cc88,#0066ff);display:flex;align-items:center;justify-content:center;font-weight:800;color:#022;flex-shrink:0}
  .badge{padding:6px 10px;border-radius:999px;font-weight:800;font-size:13px}
  .present{background:rgba(6,214,160,0.12);color:#06d6a0}
  .absent{background:rgba(239,71,111,0.12);color:#ef476f}
  .found{padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);margin-top:10px}
  .progress{height:8px;background:var(--border);border-radius:10px;overflow:hidden;margin-bottom:10px}
  .progress-fill{height:100%;background:var(--accent);width:0%;transition:width .45s}
  #dashboardCanvas{width:100%;display:block;border-radius:6px;max-height:220px;}
  .toast{position:fixed;right:18px;bottom:18px;background:rgba(12,20,32,0.95);padding:8px 12px;border-radius:10px;color:var(--accent);font-weight:800;z-index:9999}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  @media (max-width:980px){ .layout{grid-template-columns:1fr} .auth{flex-wrap:wrap} }
  .kbd{background:rgba(255,255,255,0.03);padding:4px 6px;border-radius:6px;font-weight:700}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .edit-btn{margin-left:8px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-weight:700;cursor:pointer}
  .edit-menu{position:relative; display:inline-flex; align-items:center;}
  .menu-popup{position:absolute;right:0;top:28px;background:var(--card);padding:8px;border-radius:8px;border:1px solid var(--border);z-index:9999;min-width:140px}
  .menu-popup button{display:block;width:100%;text-align:left;margin:4px 0}
  .input:focus, button:focus, select:focus { box-shadow:0 0 0 3px rgba(0,255,153,0.06); border-color:var(--accent) }
</style>
</head>
<body>
  <div class="page" role="application" aria-label="Attendance app">
    <header>
      <div class="logo" aria-hidden="true">RC</div>
      <div style="flex:1">
        <h1>R.C Technical Institute ‚Äî CO11 Attendance</h1>
        <div class="muted">Reliable attendance ‚Äî chart, export, lists, theme</div>
      </div>
      <div class="auth">
        <input id="username" class="input" placeholder="username" />
        <input id="password" class="input" placeholder="password" type="password" />
        <button id="authBtn" class="btn-primary">Login / Signup</button>
        <button id="logoutBtn" class="btn-ghost" style="display:none">Logout</button>
        <button id="themeBtn" class="btn-ghost">üåô</button>
      </div>
    </header>

    <div class="layout">
      <div>
        <div class="card">
          <div class="card-header"><div class="title">üìä Live Dashboard</div><div class="muted">Real-time attendance stats</div></div>
          <div id="statsRow" style="display:flex;gap:8px;align-items:center;margin-bottom:8px; flex-wrap:wrap;"></div>
          <canvas id="dashboardCanvas"></canvas>
        </div>

        <div style="height:12px"></div>
        
        <div class="card">
            <div class="card-header"><div class="title">üéì Overall Summary</div><div class="muted">All subjects, all time</div></div>
            <div id="summaryList" style="max-height:300px;overflow:auto" class="muted">Log in to see summary.</div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
            <div class="card-header"><div class="title">üìà Attendance Trend</div><div class="muted">History for selected subject</div></div>
            <canvas id="trendCanvas" style="max-height:150px;"></canvas>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <div class="card-header"><div class="title">üîé Mark Attendance</div><div class="muted">Click student or search</div></div>
          <div class="progress"><div id="progressFill" class="progress-fill"></div></div>

          <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px" class="controls">
            <input id="dateInput" type="date" class="input" style="width:140px" />
            <select id="subjectInput" class="input" style="width:170px"></select>
            <input id="searchInput" class="input" placeholder="enroll or name... (/)" style="flex:1" />
            <button id="searchBtn" class="btn-primary">Search</button>
          </div>

          <div id="foundArea" class="found muted">Select a student to begin marking. Use <span class="kbd">P</span>, <span class="kbd">A</span>, <span class="kbd">C</span> for quick marking.</div>
        </div>
          
        <div style="height:12px"></div>

        <div class="card">
          <div class="card-header"><div class="title">üì§ Export & Actions</div></div>
            
          <div class="controls">
            <input id="deanEmail" class="input" placeholder="Dean email" style="flex:1" />
            <button id="emailBtn" class="btn-primary">Email Dean</button>
          </div>
          
          <div style="margin-top: 12px; border-top: 1px solid var(--border); padding-top: 12px;">
            <div class="muted" style="margin-bottom: 8px;">Export Range (for selected subject):</div>
            <div class="controls">
                <input id="fromDateInput" type="date" class="input" />
                <span class="muted">to</span>
                <input id="toDateInput" type="date" class="input" />
            </div>
            <div class="controls" style="margin-top: 8px;">
                <button id="pdfBtn" class="btn-ghost">‚¨áÔ∏è PDF</button>
                <button id="csvBtn" class="btn-ghost">CSV</button>
                <button id="xlsxBtn" class="btn-ghost">Excel</button>
                <button id="lowAttPdfBtn" class="btn-ghost">‚¨áÔ∏è Low Att. PDF</button>
                <input type="file" id="importCsv" accept=".csv" style="display:none" />
                <label for="importCsv" class="btn-ghost" style="cursor:pointer">üì• Import</label>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="card-header"><div class="title">üìã Students</div><div class="muted">Click to mark ‚Ä¢ Dbl-click for details</div></div>
          <div class="master-scroll" id="studentList"></div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <div class="card-header"><div class="title">üìâ Low Attendance (&lt;70%)</div><div class="muted" id="lowAttStatus">Auto-refreshes</div></div>
          <div id="lowList" style="max-height:300px;overflow:auto" class="muted">No students below 70%</div>
        </div>
        
        <div style="height:12px"></div>

        <div class="card">
          <div class="card-header"><div class="title">üïí Recent Marks</div><div class="muted">Latest 50 actions</div></div>
          <div id="recentList" style="max-height:260px;overflow:auto" class="muted">No recent marks</div>
        </div>
      </div>
    </div>

    <footer>Built for R.C Technical Institute ‚Ä¢ Full edit & live dashboard</footer>
  </div>

  <div id="printArea" style="position:fixed;left:-9999px;top:-9999px;"></div>
  <div id="toastWrap" aria-live="polite"></div>

<script>
(function(){
  'use strict';

  const SUBJECTS = ['CPF','MATHS','PHYSICS','BE','ENGLISH'];
  const STUDENTS = [ { enrollmentNumber: "COMP101", name: "AGRAVAT SUNNY HASMUKHBHAI", class: "CO11" }, { enrollmentNumber: "COMP102", name: "AMIN VIDHI HARSIDDHKUMAR", class: "CO11" }, { enrollmentNumber: "COMP103", name: "ANSARIJULAYA MOHAMMAD TALHA", class: "CO11" }, { enrollmentNumber: "COMP105", name: "BADI MOHMADSALIK RASUL", class: "CO11" }, { enrollmentNumber: "COMP106", name: "BARAD PRIYABEN SURESHBHAI", class: "CO11" }, { enrollmentNumber: "COMP108", name: "BAROT SHLOK NAYANKUMAR", class: "CO11" }, { enrollmentNumber: "COMP109", name: "BASANTANI SUMIT GOPICHAND", class: "CO11" }, { enrollmentNumber: "COMP110", name: "BHAND YASH SUBHASHCHANDRA", class: "CO11" }, { enrollmentNumber: "COMP111", name: "BHARVAD HARDIK BHIMABHAI", class: "CO11" }, { enrollmentNumber: "COMP113", name: "BHATIYA DEEP BHAVESHBHAI", class: "CO11" }, { enrollmentNumber: "COMP114", name: "BHURIYA HETVI YOGESHKUMAR", class: "CO11" }, { enrollmentNumber: "COMP115", name: "BRAHMBHATT JIYA BHAVESH", class: "CO11" }, { enrollmentNumber: "COMP116", name: "BUHA SNEH GIRISHBHAI", class: "CO11" }, { enrollmentNumber: "COMP117", name: "BUKHARI ALISHAN ALIRAZA", class: "CO11" }, { enrollmentNumber: "COMP118", name: "BUKHARI TABISH MAHEDI ALIRAZA", class: "CO11" }, { enrollmentNumber: "COMP120", name: "CHAUHAN ASHISHBHAI KANTIBHAI", class: "CO11" }, { enrollmentNumber: "COMP122", name: "CHAUHAN JAHNAVI SOHAGKUMAR", class: "CO11" }, { enrollmentNumber: "COMP123", name: "CHAUHAN KARAN GUNVANTBHAI", class: "CO11" }, { enrollmentNumber: "COMP124", name: "CHAUHAN RISHI BHUPENDRABHAI", class: "CO11" }, { enrollmentNumber: "COMP127", name: "CHAUHAN USMITA MAHESHJI", class: "CO11" }, { enrollmentNumber: "COMP129", name: "CHAVADA PRATIK KISHANSINH", class: "CO11" }, { enrollmentNumber: "COMP130", name: "CHHODBADIA DEEP MEHULKUMAR", class: "CO11" }, { enrollmentNumber: "COMP131", name: "DABHI MITRAJSINH SANJAYSINH", class: "CO11" }, { enrollmentNumber: "COMP132", name: "DANAK VATSAL JANAKKUMAR", class: "CO11" }, { enrollmentNumber: "COMP134", name: "DARJI ASHVINI SURESHKUMAR", class: "CO11" }, { enrollmentNumber: "COMP135", name: "DARJI AYUSH MAHESHBHAI", class: "CO11" }, { enrollmentNumber: "COMP136", name: "DARJI JAL VINODBHAI", class: "CO11" }, { enrollmentNumber: "COMP137", name: "DARJI JAY MANISHBHAI", class: "CO11" }, { enrollmentNumber: "COMP139", name: "DARJI SHLOK JITENDRAKUMAR", class: "CO11" }, { enrollmentNumber: "COMP140", name: "DARJI SIDDHIBEN KANTIBHAI", class: "CO11" }, { enrollmentNumber: "COMP141", name: "DAVE AAYUSH MEHULBHAI", class: "CO11" }, { enrollmentNumber: "COMP143", name: "DAVE DHRUV JITENDRAKUMAR", class: "CO11" }, { enrollmentNumber: "COMP144", name: "DAVE KHWAISH MEHUL", class: "CO11" }, { enrollmentNumber: "COMP145", name: "DAVE SHIVAM RUPESHKUMAR", class: "CO11" }, { enrollmentNumber: "COMP146", name: "DEDAKIYA JAYMIN NAYANBHAI", class: "CO11" }, { enrollmentNumber: "COMP147", name: "DESAI ANKESHKUMAR MERAJBHAI", class: "CO11" }, { enrollmentNumber: "COMP148", name: "DESAI ISHAN NARANBHAI", class: "CO11" }, { enrollmentNumber: "COMP149", name: "DESAI PRAKASHBHAI RANABHAI", class: "CO11" }, { enrollmentNumber: "COMP150", name: "DHOBI HARSH SACHINKUMAR", class: "CO11" }, { enrollmentNumber: "COMP151", name: "DHOKIYA SHLOKKUMAR ARAVINDBHAI", class: "CO11" }, { enrollmentNumber: "COMP152", name: "DHRUVESH PATEL", class: "CO11" }, { enrollmentNumber: "COMP153", name: "DIVYESH MITESH CHHATBAR", class: "CO11" }, { enrollmentNumber: "COMP154", name: "DIWAN AKSHAY AMIT", class: "CO11" }, { enrollmentNumber: "COMP155", name: "DIWAN REHAN AHMED MO. JAVED", class: "CO11" }, { enrollmentNumber: "COMP156", name: "DOMADIYA MEET SHAILESHBHAI", class: "CO11" }, { enrollmentNumber: "COMP157", name: "DOMADIYA MOHIT RATILAL", class: "CO11" }, { enrollmentNumber: "COMP158", name: "DONGA YUG VIPULBHAI", class: "CO11" }, { enrollmentNumber: "COMP160", name: "GADHAVI TWISHA VIJAYDAN", class: "CO11" }, { enrollmentNumber: "COMP162", name: "GAJJAR RUDRA MAULIK", class: "CO11" }, { enrollmentNumber: "COMP163", name: "GAUTAM SHUBHAM SATYAPRAKASH", class: "CO11" }, { enrollmentNumber: "COMP164", name: "GORE SAKSHI VILAS", class: "CO11" }, { enrollmentNumber: "COMP165", name: "GORECHA SHUBHAM HIRENKUMAR", class: "CO11" }, { enrollmentNumber: "COMP167", name: "GOTHI KULDEEPKUMAR DHARMENDRA", class: "CO11" }, { enrollmentNumber: "COMP168", name: "GUPTA VANSHIK PARESHKUMAR", class: "CO11" }, { enrollmentNumber: "COMP169", name: "GURJAR PARTHKUMAR DEVRAMBHAI", class: "CO11" }, { enrollmentNumber: "COMP171", name: "HENIL PARIKH", class: "CO11" }, { enrollmentNumber: "COMP172", name: "JADAV VAIDIK VIJAYBHAI", class: "CO11" }, { enrollmentNumber: "COMP173", name: "JAIN DARSHIL JITENDRA", class: "CO11" }, { enrollmentNumber: "COMP174", name: "JAIN LOVE MANISHBHAI", class: "CO11" }, { enrollmentNumber: "COMP175", name: "JAISVAR ABHISHEK RAMBALI", class: "CO11" }, { enrollmentNumber: "COMP176", name: "JANDIYA VAIBHAV ISHWARBHAI", class: "CO11" }, { enrollmentNumber: "COMP177", name: "JANI YASHVI VIPULBHAI", class: "CO11" }, { enrollmentNumber: "COMP178", name: "JAWALE DHAKESH YOGESH", class: "CO11" }, { enrollmentNumber: "COMP179", name: "JAYSWAL DAKSH DIPAKKUMAR", class: "CO11" }, { enrollmentNumber: "COMP180", name: "BHALIYA BHAIRAVI KIRITBHAI", class: "CO11" }, { enrollmentNumber: "COMP181", name: "BHAVSAR KARTIK MITESHKUMAR", class: "CO11" }, { enrollmentNumber: "COMP182", name: "BHAVYA CHANDRAKANT PRAJAPATI", class: "CO11" }, { enrollmentNumber: "COMP183", name: "CHAUDHARI BHAVY DINESHBHAI", class: "CO11" }, { enrollmentNumber: "COMP184", name: "CHAUHAN DIXITA DILIPBHAI", class: "CO11" }, { enrollmentNumber: "COMP185", name: "CHAUHAN VIVEK", class: "CO11" }, { enrollmentNumber: "COMP186", name: "CHHATBAR HET ALPESH", class: "CO11" }, { enrollmentNumber: "COMP187", name: "CHITRODA JAY SANJAYBHAI", class: "CO11" }, { enrollmentNumber: "COMP188", name: "DARJI ARYAN SANJAYBHAI", class: "CO11" }, { enrollmentNumber: "COMP189", name: "DESAI ARYAN KALPESHBHAI", class: "CO11" }, { enrollmentNumber: "COMP191", name: "DODIYA ADITI BHUPENDRABHAI", class: "CO11" }, { enrollmentNumber: "COMP192", name: "GAJJAR BHAVYAKUMAR VIPULKUMAR", class: "CO11" }, { enrollmentNumber: "COMP193", name: "GANDHARVA KARINA JITESHKUMAR", class: "CO11" }, { enrollmentNumber: "COMP194", name: "HEMAL NAGAR", class: "CO11" }, { enrollmentNumber: "COMP195", name: "KANHA SENJALIYA", class: "CO11" } ];
  const STORAGE_KEY = 'rc_co11_attendance_v6';

  // --- UTILITIES & STATE ---
  const $ = id => document.getElementById(id);
  function mk(tag, props = {}, children = []) { const e = document.createElement(tag); Object.entries(props).forEach(([key, value]) => { if (key === 'class') e.className = value; else if (key === 'text') e.textContent = value; else if (key === 'html') e.innerHTML = value; else e.setAttribute(key, value); }); (Array.isArray(children) ? children : [children]).flat().forEach(c => { if (typeof c === 'string') e.appendChild(document.createTextNode(c)); else if (c instanceof Node) e.appendChild(c); }); return e; }
  const escape = s => String(s == null ? '' : s);
  const today = () => new Date().toISOString().slice(0, 10);
  function showToast(msg, ms = 2000) { const w = $('toastWrap'); w.innerHTML = ''; const t = mk('div', { class: 'toast', text: msg }); w.appendChild(t); setTimeout(() => t.remove(), ms); }
  const getInitialUserData = () => ({ attendance: {}, lectureDates: {}, recent: {}, settings: { theme: 'dark' } });
  let state = { users: {}, currentUser: null };
  let userData = getInitialUserData();
  let currentStudentEnrollment = null;
  function safeLoad() { try { const raw = localStorage.getItem(STORAGE_KEY); if (raw) { const loadedState = JSON.parse(raw); state.users = loadedState.users || {}; state.currentUser = null; } } catch (e) { console.warn('State load failed:', e); state = { users: {}, currentUser: null }; } }
  const safeSave = () => { try { if (state.currentUser && state.users[state.currentUser]) { state.users[state.currentUser].data = userData; } localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) { console.warn('State save failed:', e); } };
  const nodes = { dateInput: $('dateInput'), subjectInput: $('subjectInput'), searchInput: $('searchInput'), searchBtn: $('searchBtn'), foundArea: $('foundArea'), studentList: $('studentList'), recentList: $('recentList'), lowList: $('lowList'), statsRow: $('statsRow'), dashboardCanvas: $('dashboardCanvas'), trendCanvas: $('trendCanvas'), progressFill: $('progressFill'), pdfBtn: $('pdfBtn'), csvBtn: $('csvBtn'), xlsxBtn: $('xlsxBtn'), lowAttStatus: $('lowAttStatus'), themeBtn: $('themeBtn'), authBtn: $('authBtn'), logoutBtn: $('logoutBtn'), username: $('username'), password: $('password'), fromDateInput: $('fromDateInput'), toDateInput: $('toDateInput'), deanEmail: $('deanEmail'), emailBtn: $('emailBtn'), summaryList: $('summaryList'), lowAttPdfBtn: $('lowAttPdfBtn') };
  let dashboardChart = null;
  let trendChart = null;

  // --- RENDER FUNCTIONS ---
  function updateDashboardChart() { /* ... (Code is unchanged from previous working version) ... */ }
  function renderTrendChart() { /* ... (Code is unchanged from previous working version) ... */ }
  function renderStudents() { /* ... (Code is unchanged from previous working version) ... */ }
  function renderRecent() { /* ... (Code is unchanged from previous working version) ... */ }
  
  function getLowAttendanceStudents(threshold = 70) {
    const totalLectures = Object.values(userData.lectureDates || {}).reduce((acc, dates) => acc + (dates ? dates.length : 0), 0);
    if (totalLectures === 0) return [];
    return STUDENTS.map(st => {
      let presentCount = 0;
      const attData = userData.attendance[st.enrollmentNumber] || { dates: {} };
      Object.values(attData.dates).forEach(subjects => {
        Object.values(subjects).forEach(data => { if (data.status === 'present') presentCount++; });
      });
      const perc = totalLectures > 0 ? Math.round((presentCount / totalLectures) * 100) : 0;
      return { st, present: presentCount, totalLect: totalLectures, perc };
    }).filter(r => r.perc < threshold).sort((a, b) => a.perc - b.perc);
  }

  function renderLow() {
    nodes.lowList.innerHTML = '';
    const rows = getLowAttendanceStudents(70);
    if (!rows.length) { nodes.lowList.classList.add('muted'); nodes.lowList.textContent = 'No students below 70%'; return; }
    nodes.lowList.classList.remove('muted');
    rows.forEach(r => {
      const left = mk('div', { style: 'display:flex; gap:12px; align-items:center;' }, [ mk('div', { class: 'avatar', text: r.st.name.split(' ').slice(0, 2).map(n => n[0] || '').join('') }), mk('div', {}, [mk('div', { style: 'font-weight:800', text: r.st.name }), mk('div', { class: 'muted', text: `${r.st.enrollmentNumber} ‚Ä¢ ${r.present}/${r.totalLect}` })]) ]);
      const badge = mk('div', { class: 'badge absent', text: `${r.perc}%` });
      nodes.lowList.appendChild(mk('div', { class: 'row' }, [left, badge]));
    });
  }

  function renderSummary() {
    nodes.summaryList.innerHTML = '';
    if (!state.currentUser) { nodes.summaryList.classList.add('muted'); nodes.summaryList.textContent = 'Log in to see summary.'; return; }
    const totalLectures = Object.values(userData.lectureDates || {}).reduce((acc, dates) => acc + (dates ? dates.length : 0), 0);
    if (totalLectures === 0) { nodes.summaryList.classList.add('muted'); nodes.summaryList.textContent = 'No lecture data recorded yet.'; return; }
    nodes.summaryList.classList.remove('muted');
    const summaryData = STUDENTS.map(st => {
      let presentCount = 0;
      const attData = userData.attendance[st.enrollmentNumber] || { dates: {} };
      Object.values(attData.dates).forEach(subjects => {
        Object.values(subjects).forEach(data => { if (data.status === 'present') presentCount++; });
      });
      const perc = totalLectures > 0 ? Math.round((presentCount / totalLectures) * 100) : 0;
      return { st, present: presentCount, perc };
    }).sort((a, b) => a.perc - b.perc);
    summaryData.forEach(r => {
      const left = mk('div', { style: 'display:flex; gap:12px; align-items:center;' }, [ mk('div', { class: 'avatar', text: r.st.name.split(' ').slice(0, 2).map(n => n[0] || '').join('') }), mk('div', {}, [mk('div', { style: 'font-weight:800', text: r.st.name }), mk('div', { class: 'muted', text: `${r.present}/${totalLectures} Lectures` })]) ]);
      const badgeClass = r.perc >= 70 ? 'badge present' : 'badge absent';
      const badge = mk('div', { class: badgeClass, text: `${r.perc}%` });
      nodes.summaryList.appendChild(mk('div', { class: 'row' }, [left, badge]));
    });
  }
  
  function renderAll() { renderStudents(); updateDashboardChart(); renderTrendChart(); renderLow(); renderRecent(); renderSummary(); }

  // --- CORE LOGIC & ACTIONS ---
  function mark(enrollment, subject, date, status, opts = {}) { /* ... (Code is unchanged from previous working version) ... */ };
  function clearMark(enrollment, subject, date) { /* ... (Code is unchanged from previous working version) ... */ };
  function showFound(student) { /* ... (Code is unchanged from previous working version) ... */ }
  
  // --- EXPORT LOGIC (FIXED) ---
  function getMultiDaySnapshot(fromDate, toDate, subject) {
    if (!fromDate || !toDate || toDate < fromDate) {
      showToast('Invalid date range selected.');
      return null;
    }
    const relevantDates = (userData.lectureDates[subject] || []).filter(d => d >= fromDate && d <= toDate).sort();
    if (relevantDates.length === 0) {
      showToast('No lecture data found in the selected range for this subject.');
      return null;
    }
    const data = STUDENTS.map(student => {
      const row = { Enrollment: student.enrollmentNumber, Name: student.name };
      relevantDates.forEach(date => {
        row[date] = userData.attendance[student.enrollmentNumber]?.dates?.[date]?.[subject]?.status || '‚Äî';
      });
      return row;
    });
    return { data, dates: relevantDates };
  }
    
  nodes.csvBtn.addEventListener('click', () => {
    const { fromDateInput, toDateInput, subjectInput } = nodes;
    const snapshot = getMultiDaySnapshot(fromDateInput.value, toDateInput.value, subjectInput.value);
    if (!snapshot) return;
    const { data } = snapshot;
    const ws = XLSX.utils.json_to_sheet(data);
    const csv = XLSX.utils.sheet_to_csv(ws);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8,' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Attendance_${subjectInput.value}_${fromDateInput.value}_to_${toDateInput.value}.csv`;
    link.click();
    showToast('CSV downloaded');
  });

  nodes.xlsxBtn.addEventListener('click', () => {
    const { fromDateInput, toDateInput, subjectInput } = nodes;
    const snapshot = getMultiDaySnapshot(fromDateInput.value, toDateInput.value, subjectInput.value);
    if (!snapshot) return;
    const { data } = snapshot;
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Attendance');
    XLSX.writeFile(wb, `Attendance_${subjectInput.value}_${fromDateInput.value}_to_${toDateInput.value}.xlsx`);
    showToast('Excel downloaded');
  });
    
  nodes.pdfBtn.addEventListener('click', async () => {
    const { fromDateInput, toDateInput, subjectInput } = nodes;
    const snapshot = getMultiDaySnapshot(fromDateInput.value, toDateInput.value, subjectInput.value);
    if (!snapshot) return;
    const { data, dates } = snapshot;
    
    showToast('Generating PDF...');
    const header = ['Enrollment', 'Name', ...dates].map(h => `<th style="padding:4px 6px; border:1px solid #ddd; background:#eee; color:#000;">${escape(h)}</th>`).join('');
    const body = data.map(row => `<tr>${Object.values(row).map(v => `<td style="padding:4px 6px; border:1px solid #ddd; color:#000;">${escape(v)}</td>`).join('')}</tr>`).join('');
    const printableHTML = `<div style="font-family:Arial; padding:20px; background:white; color:black;"><h3 style="color:#000;">Attendance for ${subjectInput.value}</h3><p style="color:#333; font-size: 12px;">From: ${fromDateInput.value} To: ${toDateInput.value}</p><table style="border-collapse:collapse; width:100%; font-size:10px;"><thead><tr>${header}</tr></thead><tbody>${body}</tbody></table></div>`;

    const pa = $('printArea');
    pa.innerHTML = printableHTML;
    
    try {
        const { jsPDF } = window.jspdf;
        const canvas = await html2canvas(pa.firstElementChild, { scale: 2 });
        const pdf = new jsPDF('l', 'pt', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const ratio = canvas.width / pdfWidth;
        const pageCanvasHeight = pdfHeight * ratio;
        
        let renderedHeight = 0;
        while (renderedHeight < canvas.height) {
            if (renderedHeight > 0) pdf.addPage();
            const sliceHeight = Math.min(pageCanvasHeight, canvas.height - renderedHeight);
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = sliceHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, renderedHeight, canvas.width, sliceHeight, 0, 0, canvas.width, sliceHeight);
            pdf.addImage(tempCanvas.toDataURL('image/png'), 'PNG', 0, 0, pdfWidth, sliceHeight / ratio);
            renderedHeight += sliceHeight;
        }

        pdf.save(`Attendance_${subjectInput.value}_${fromDateInput.value}_to_${toDateInput.value}.pdf`);
        showToast('PDF downloaded');
    } catch(e) { console.error("PDF generation failed:", e); showToast("PDF generation failed."); } finally { pa.innerHTML = ''; }
  });

  nodes.lowAttPdfBtn.addEventListener('click', async () => {
    if (!state.currentUser) return showToast('Please log in to export.');
    const lowStudents = getLowAttendanceStudents(70);
    if (lowStudents.length === 0) return showToast('No students with low attendance to report.');
    showToast('Generating Low Attendance PDF...');
    const tableHeader = `<tr><th style="padding:6px 8px; border:1px solid #ddd; background:#eee; color:#000;">Enrollment</th><th style="padding:6px 8px; border:1px solid #ddd; background:#eee; color:#000;">Name</th><th style="padding:6px 8px; border:1px solid #ddd; background:#eee; color:#000;">Attendance</th><th style="padding:6px 8px; border:1px solid #ddd; background:#eee; color:#000;">Percentage</th></tr>`;
    const tableBody = lowStudents.map(s => `<tr><td style="padding:6px 8px; border:1px solid #ddd; color:#000;">${escape(s.st.enrollmentNumber)}</td><td style="padding:6px 8px; border:1px solid #ddd; color:#000;">${escape(s.st.name)}</td><td style="padding:6px 8px; border:1px solid #ddd; color:#000;">${s.present}/${s.totalLect}</td><td style="padding:6px 8px; border:1px solid #ddd; color:#ef476f; font-weight:bold;">${s.perc}%</td></tr>`).join('');
    const printableHTML = `<div style="font-family:Arial; padding:20px; background:white; color:black;"><h2 style="color:#000;">Low Attendance Report (&lt;70%)</h2><p style="color:#333; font-size: 12px;">Generated on: ${new Date().toLocaleString()}</p><table style="border-collapse:collapse; width:100%; font-size:11px;"><thead>${tableHeader}</thead><tbody>${tableBody}</tbody></table></div>`;
    const pa = $('printArea');
    pa.innerHTML = printableHTML;
    try {
        const { jsPDF } = window.jspdf;
        const canvas = await html2canvas(pa.firstElementChild, { scale: 2 });
        const pdf = new jsPDF('p', 'pt', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, pdfWidth, canvas.height * pdfWidth / canvas.width);
        pdf.save(`Low_Attendance_Report_${today()}.pdf`);
        showToast('PDF downloaded');
    } catch(e) { console.error("PDF generation failed:", e); showToast("PDF generation failed."); } finally { pa.innerHTML = ''; }
  });
  
  // --- AUTH & INIT ---
  function applyTheme(t) { const theme = t === 'light' ? 'light' : 'dark'; document.documentElement.dataset.theme = theme; userData.settings.theme = theme; nodes.themeBtn.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è'; if (dashboardChart) { dashboardChart.destroy(); trendChart.destroy(); dashboardChart = null; trendChart = null; renderAll(); } }
  function hash(s){ let h=0; for(let i=0;i<s.length;i++) h=(Math.imul(31,h)+s.charCodeAt(i))|0; return String(h); }
  function loadUserSession(username) { state.currentUser = username; userData = JSON.parse(JSON.stringify(state.users[username].data)); updateAuthUI(); applyTheme(userData.settings.theme); renderAll(); }
  function clearUserSession() { state.currentUser = null; userData = getInitialUserData(); updateAuthUI(); if (dashboardChart) { dashboardChart.destroy(); dashboardChart = null; } if (trendChart) { trendChart.destroy(); trendChart = null; } renderAll(); }
  function updateAuthUI(){ const loggedIn = !!state.currentUser; nodes.logoutBtn.style.display = loggedIn ? 'inline-block' : 'none'; nodes.authBtn.style.display = loggedIn ? 'none' : 'inline-block'; nodes.username.style.display = loggedIn ? 'none' : 'inline-block'; nodes.password.style.display = loggedIn ? 'none' : 'inline-block'; }
  nodes.authBtn.addEventListener('click', ()=>{ const u = nodes.username.value.trim(), p = nodes.password.value.trim(); if(!u || !p){ showToast('Enter username & password'); return; } const key = u.toLowerCase(); if(state.users[key]){ if(state.users[key].pwd !== hash(p)) { showToast('Invalid password'); return; } state.users[key].data = state.users[key].data || getInitialUserData(); loadUserSession(key); safeSave(); showToast('Logged in successfully!'); } else { state.users[key] = { pwd: hash(p), data: getInitialUserData() }; safeSave(); loadUserSession(key); showToast('Account created & logged in'); } });
  nodes.logoutBtn.addEventListener('click', ()=> { safeSave(); state.currentUser = null; safeSave(); clearUserSession(); showToast('Logged out.'); });
  
  function init() {
    nodes.subjectInput.innerHTML = '';
    SUBJECTS.forEach(s => nodes.subjectInput.appendChild(mk('option', { value: s, text: s })));
    nodes.dateInput.value = today();
    nodes.fromDateInput.value = today();
    nodes.toDateInput.value = today();
    safeLoad(); updateAuthUI(); applyTheme(userData.settings.theme); renderAll();
    nodes.subjectInput.addEventListener('change', renderAll);
    nodes.dateInput.addEventListener('change', renderAll);
    nodes.themeBtn.addEventListener('click', () => applyTheme(userData.settings.theme === 'dark' ? 'light' : 'dark'));
    nodes.searchBtn.addEventListener('click', () => { if (!state.currentUser) return showToast('Please log in to search.'); const q = nodes.searchInput.value.trim().toLowerCase(); if (!q) return showToast('Enter enrollment or name'); const found = STUDENTS.find(s => s.enrollmentNumber.toLowerCase() === q || s.name.toLowerCase().includes(q)); if (!found) return showToast('Student not found'); showFound(found); const node = document.querySelector(`[data-enroll="${found.enrollmentNumber}"]`); if (node) { node.scrollIntoView({ behavior: 'smooth', block: 'center' }); node.classList.add('highlight'); setTimeout(() => node.classList.remove('highlight'), 1500); } });
    document.addEventListener('keydown', e => { if (['INPUT', 'SELECT', 'TEXTAREA'].includes(document.activeElement.tagName)) return; if (e.key === '/') { e.preventDefault(); nodes.searchInput.focus(); return; } if (nodes.foundArea.querySelector('button')) { const keyMap = { 'p': 'Present', 'a': 'Absent', 'c': 'Clear' }; const action = keyMap[e.key.toLowerCase()]; if (action) { e.preventDefault(); const button = Array.from(nodes.foundArea.querySelectorAll('button')).find(b => b.textContent === action); if (button) button.click(); } } });
    console.log('Enhanced Attendance app ready.');
  }
  
  // --- RE-ADDED FULL FUNCTION DEFINITIONS FOR CLARITY AND CORRECTNESS ---
  updateDashboardChart = function() {
    const subject = nodes.subjectInput.value; const date = nodes.dateInput.value; let present = 0, absent = 0;
    STUDENTS.forEach(s => { const status = userData.attendance[s.enrollmentNumber]?.dates?.[date]?.[subject]?.status; if (status === 'present') present++; else if (status === 'absent') absent++; });
    const unmarked = STUDENTS.length - (present + absent);
    nodes.statsRow.innerHTML = ''; ['Present', 'Absent', 'Unmarked'].forEach(s => { const count = { Present: present, Absent: absent, Unmarked: unmarked }[s]; const badgeClass = s === 'Unmarked' ? 'badge' : `badge ${s.toLowerCase()}`; nodes.statsRow.appendChild(mk('div', { class: badgeClass, html: `${s}: <b>${count}</b>` })); });
    nodes.progressFill.style.width = `${STUDENTS.length ? Math.round((present + absent) / STUDENTS.length * 100) : 0}%`;
    const data = [present, absent, unmarked]; const textColor = getComputedStyle(document.body).getPropertyValue('--text');
    if (dashboardChart) { dashboardChart.data.labels = ['Present', 'Absent', 'Unmarked']; dashboardChart.data.datasets[0].data = data; dashboardChart.options.plugins.title.text = `${subject} ‚Äî ${date}`; dashboardChart.update(); } else { dashboardChart = new Chart(nodes.dashboardCanvas.getContext('2d'), { type: 'pie', data: { labels: ['Present', 'Absent', 'Unmarked'], datasets: [{ data, backgroundColor: ['#06d6a0', '#ef476f', '#778da9'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor } }, title: { display: true, text: `${subject} ‚Äî ${date}`, color: textColor } } } }); }
  };
  renderTrendChart = function() {
    const subject = nodes.subjectInput.value; const lectureDates = (userData.lectureDates[subject] || []).sort();
    const dataPoints = lectureDates.map(date => { let present = 0, totalMarked = 0; STUDENTS.forEach(s => { const status = userData.attendance[s.enrollmentNumber]?.dates?.[date]?.[subject]?.status; if (status === 'present') { present++; totalMarked++; } else if (status === 'absent') { totalMarked++; } }); return totalMarked > 0 ? (present / totalMarked) * 100 : 0; });
    const textColor = getComputedStyle(document.body).getPropertyValue('--text'); const borderColor = getComputedStyle(document.body).getPropertyValue('--border');
    if (trendChart) { trendChart.data.labels = lectureDates; trendChart.data.datasets[0].data = dataPoints; trendChart.update(); } else { trendChart = new Chart(nodes.trendCanvas.getContext('2d'), { type: 'line', data: { labels: lectureDates, datasets: [{ label: 'Turnout %', data: dataPoints, fill: true, borderColor: 'var(--accent)', tension: 0.1, backgroundColor: 'rgba(0, 255, 153, 0.1)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, ticks: { color: textColor, callback: (value) => value.toFixed(0) + '%' }, grid: { color: borderColor } },  x: { ticks: { color: textColor, autoSkip: true, maxTicksLimit: 15 }, grid: { color: borderColor } } } } }); }
  };
  renderStudents = function() {
    const date = nodes.dateInput.value; const subject = nodes.subjectInput.value; const container = nodes.studentList; container.innerHTML = '';
    if (!state.currentUser) { container.classList.add('muted'); container.textContent = 'Please log in to view students.'; return; }
    container.classList.remove('muted');
    STUDENTS.forEach(st => { userData.attendance[st.enrollmentNumber] = userData.attendance[st.enrollmentNumber] || { dates: {} }; const status = userData.attendance[st.enrollmentNumber]?.dates?.[date]?.[subject]?.status || '‚Äî'; const statusClass = { present: 'present', absent: 'absent' }[status] || '';
      const editBtn = mk('button', { class: 'edit-btn', text: 'Edit' }); editBtn.addEventListener('click', ev => { ev.stopPropagation(); document.querySelectorAll('.menu-popup').forEach(n => n.remove()); const popup = mk('div', { class: 'menu-popup' }); ['present', 'absent', 'undo'].forEach(opt => { const b = mk('button', { text: opt === 'undo' ? 'Clear Mark' : opt.charAt(0).toUpperCase() + opt.slice(1) }); b.addEventListener('click', e => { e.stopPropagation(); popup.remove(); opt === 'undo' ? clearMark(st.enrollmentNumber, subject, date) : mark(st.enrollmentNumber, subject, date, opt); }); popup.appendChild(b); }); editBtn.parentElement.appendChild(popup); const closeHandler = e => { if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closeHandler); } }; setTimeout(() => document.addEventListener('click', closeHandler), 10); });
      const rowClasses = ['row']; if(st.enrollmentNumber === currentStudentEnrollment) rowClasses.push('current');
      const row = mk('div', { class: rowClasses.join(' '), 'data-enroll': st.enrollmentNumber }, [ mk('div', { style: 'display:flex;align-items:center;gap:12px;' }, [ mk('div', { class: 'avatar', text: st.name.split(' ').slice(0, 2).map(n => n[0] || '').join('') }), mk('div', {}, [ mk('div', { style: 'font-weight:800', text: st.name }), mk('div', { class: 'muted', text: st.enrollmentNumber }) ]) ]), mk('div', {}, [ mk('div', { class: `badge ${statusClass}`, text: status.charAt(0).toUpperCase() + status.slice(1) }), mk('div', { class: 'edit-menu' }, [editBtn]) ]) ]);
      row.addEventListener('click', () => showFound(st)); container.appendChild(row);
    });
  };
  renderRecent = function() {
    const subject = nodes.subjectInput.value; nodes.recentList.innerHTML = ''; const list = (userData.recent[subject] || []).slice().reverse().slice(0, 50);
    if (!list.length) { nodes.recentList.classList.add('muted'); nodes.recentList.textContent = 'No recent marks'; return; }
    nodes.recentList.classList.remove('muted');
    list.forEach(item => { const left = mk('div', { style: 'display:flex; align-items:center; gap:12px;' }, [ mk('div', { class: 'avatar', text: (item.student || item.enrollment).split(' ').slice(0, 2).map(n => n[0] || '').join('') }), mk('div', {}, [ mk('div', { style: 'font-weight:800', text: item.student }), mk('div', { class: 'muted', text: `${item.enrollment} ‚Ä¢ ${item.date} ‚Ä¢ ${item.timestamp}` }) ]) ]); const status = item.status || 'unmarked'; const badge = mk('div', { class: `badge ${status}`, text: status.charAt(0).toUpperCase() + status.slice(1) }); nodes.recentList.appendChild(mk('div', { class: 'row' }, [left, badge])); });
  };
  mark = function(enrollment, subject, date, status, opts = {}) { if (!state.currentUser) return showToast('Please sign in.'); const rec = userData.attendance[enrollment] = userData.attendance[enrollment] || { dates: {} }; rec.dates[date] = rec.dates[date] || {}; rec.dates[date][subject] = { status, timestamp: new Date().toLocaleTimeString() }; userData.lectureDates[subject] = userData.lectureDates[subject] || []; if (!userData.lectureDates[subject].includes(date)) { userData.lectureDates[subject].push(date); userData.lectureDates[subject].sort(); } userData.recent[subject] = (userData.recent[subject] || []).filter(r => !(r.enrollment === enrollment && r.date === date)); userData.recent[subject].push({ enrollment, student: STUDENTS.find(s => s.enrollmentNumber === enrollment)?.name || enrollment, status, subject, date, timestamp: rec.dates[date][subject].timestamp }); safeSave(); renderAll(); if (!opts.silent) showToast(`Marked ${status} for ${enrollment}`); };
  clearMark = function(enrollment, subject, date) { if (!state.currentUser) return showToast('Please sign in.'); const rec = userData.attendance[enrollment]; if (!rec?.dates?.[date]?.[subject]) return showToast('No mark to clear'); delete rec.dates[date][subject]; if (!STUDENTS.some(s => userData.attendance[s.enrollmentNumber]?.dates[date]?.[subject])) { userData.lectureDates[subject] = userData.lectureDates[subject].filter(d => d !== date); } userData.recent[subject] = userData.recent[subject].filter(r => !(r.enrollment === enrollment && r.date === date)); safeSave(); renderAll(); showToast('Cleared mark'); };
  showFound = function(student) {
    if (!state.currentUser) return; currentStudentEnrollment = student.enrollmentNumber; renderStudents(); nodes.foundArea.innerHTML = ''; const date = nodes.dateInput.value; const subject = nodes.subjectInput.value; const rec = userData.attendance[student.enrollmentNumber]?.dates?.[date]?.[subject];
    const header = mk('div', { style: 'display:flex; justify-content:space-between; align-items:center;' }, [ mk('div', {}, [ mk('div', { style: 'font-weight:800', text: student.name }), mk('div', { class: 'muted', style: 'margin-top:6px', text: student.enrollmentNumber }) ]), mk('div', { style: 'text-align:right;' }, [ mk('div', { class: 'muted', text: `${subject} ‚Ä¢ ${date}` }), mk('div', { style: 'font-weight:900', text: rec ? rec.status.charAt(0).toUpperCase() + rec.status.slice(1) : '‚Äî' }) ]) ]);
    const actions = mk('div', { style: 'margin-top:10px; display:flex; gap:8px;' }); const actionHandler = (action) => { const status = action.toLowerCase(); status === 'clear' ? clearMark(student.enrollmentNumber, subject, date) : mark(student.enrollmentNumber, subject, date, status); const currentIndex = STUDENTS.findIndex(s => s.enrollmentNumber === student.enrollmentNumber); if (currentIndex > -1 && currentIndex < STUDENTS.length - 1) { showFound(STUDENTS[currentIndex + 1]); } else { nodes.foundArea.innerHTML = mk('div', { class: 'muted', text: 'Reached the end of the student list.' }).outerHTML; currentStudentEnrollment = null; renderStudents(); showToast('All students processed!'); } };
    ['Present', 'Absent', 'Clear'].forEach(action => { const btn = mk('button', { class: action === 'Present' ? 'btn-primary' : 'btn-ghost', text: action }); btn.addEventListener('click', () => actionHandler(action)); actions.appendChild(btn); });
    nodes.foundArea.appendChild(header); nodes.foundArea.appendChild(actions);
  };
  
  init();

})();
</script>
</body>
</html>
